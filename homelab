#!/bin/bash
source $(dirname $0)/scripts/utils.sh
source $(dirname $0)/scripts/libnotify.sh
source $(dirname $0)/scripts/help.sh
source $(dirname $0)/scripts/cache.sh
source $(dirname $0)/scripts/sites.sh
source $(dirname $0)/scripts/open.sh
source $(dirname $0)/scripts/supervisor.sh
source $(dirname $0)/scripts/database.sh
source $(dirname $0)/scripts/installer.sh
source $(dirname $0)/scripts/docker.sh
source $(dirname $0)/scripts/backup.sh
source $(dirname $0)/scripts/goaccess.sh
source $(dirname $0)/scripts/generate-override.sh
source $(dirname $0)/scripts/recreate-ssl.sh
source $(dirname $0)/scripts/check_updates.sh
openCD $0
agentData=$RANDOM
set -a && source DOCKER/.env && set +a
shift $((OPTIND -1))

subcommand=$1; shift

case "$subcommand" in
  up)
    clear
    if [ -f "logs/startup.pid" ]; then
      header
      send_notify "Containers already started" 'process-working-symbolic'
      rightH1 $YELLOW 'Containers already started' $WHITE '☐' "."
      footer
      exit 1
    fi
    startExec0000=$(date +'%s')
    header
    ln
    refactor_fn
    check_and_pull_updates
    docker_updates
    docker_up_master
    ln
    www
    if [ $OPEN_BROWSER_PROJECT_START == true ]; then
      open "browser" "mini"
    fi
    footer
    send_notify "Startup containers" 'process-working-symbolic'
  ;;
  check-updates)
    header
    ln
    check_and_pull_updates
    footer
  ;;
  ps)
    header
    ln
    docker_ps
    footer
  ;;
  runonce)
    header
    ln
    runonce_fn
    footer
  ;;
  goaccess)
    header
    ln
    goaccess
    footer
  ;;
  restart)
    header
    startup
    ln
    directory_cli=$PWD
    docker_bash "homelab-php7" "logs-chmod:root"
    docker_restart
    ln
    runonce_fn
    ln
    goaccess
    footer
  ;;
  clear)  
    header
    startup
    ln
    directory_cli=$PWD
    docker_bash "homelab-php7" "logs-chmod:root"
    clearLogs
    openCD $0 
    if [ -f "logs/startup.pid" ]; then
      ln
      docker_restart
      ln
      runonce_fn
    fi
    footer
  ;;
  help)
    header
    ln
    help "$@"
    footer
  ;;
  cache)
    header
    ln
    cache_cmd "$@"
    footer
  ;;
  install)
    header
    ln
    installer
    footer
    send_notify "Installing and Startup containers" 'process-working-symbolic'
  ;;
  logs)
    header
    ln
    docker_logs "$@"
    footer
  ;;
  bash)
    if [ "$2" == '--user' ]; then
      docker_bash "$1" "bash:${USERNAME}"
    else
      docker_bash "$1" "bash:root"
    fi
  ;;
  dumpsdb)
    header
    ln
    dumpsdb "$@"
    footer
  ;;
  dropdb)
    header
    dropdb "$@"
    ln
    footer
  ;;
  createdb)
    header
    createdb "$@"
    ln
    footer
  ;;
  importdb)
    header
    importdb "$@"
    ln
    footer
  ;;
  php8)
    if [ "$1" == '--user' ]; then
      docker_bash "homelab-php8" "bash:${USERNAME}"
    else
      docker_bash "homelab-php8" "bash:root"
    fi
  ;;
  php7)
    if [ "$1" == '--user' ]; then
      docker_bash "homelab-php7" "bash:${USERNAME}"
    else
      docker_bash "homelab-php7" "bash:root"
    fi
  ;;
  php8-cli)
    docker_bash "homelab-php8" "php:${USERNAME}" $@
  ;;
  php7-cli)
    docker_bash "homelab-php7" "php:${USERNAME}" $@
  ;;
  php8-composer)
    docker_bash "homelab-php8" "composer:${USERNAME}" $@
  ;;
  php7-composer)
    docker_bash "homelab-php7" "composer:${USERNAME}" $@
  ;;
  recreate-ssl)
    header
    ln
    recreate-ssl
    footer
  ;;
  newsubdomain)
    header
    ln
    newsite 0 $@
    footer
  ;;
  newdomain)
    header
    ln
    newsite 1 $@
    footer
  ;;
  legacydomain)
    header
    ln
    newsite 2 $@
    footer
  ;;
  legacysubdomain)
    header
    ln
    newsite 3 $@
    footer
  ;;
  delsubdomain)
    header
    ln
    delsite 0 $@
    footer
  ;;
  deldomain)
    header
    ln
    delsite 1 $@
    footer
  ;;
  listsite)
    header
    ln
    www
    footer
  ;;
  open)
    header
    ln
    open $@
    footer
  ;;
  newsupervisor)
    header
    ln
    newSupervisor $@
    footer
  ;;
  delsupervisor)
    header
    ln
    delSupervisor $@
    footer
  ;;
  listsupervisor)
    header
    ln
    listSupervisor $@
    footer
  ;;
  startsupervisor)
    header
    ln
    startedSupervisor $@
    footer
  ;;
  down)
    clear
    header
    directory_cli=$PWD
    docker_bash "homelab-php8" "logs-chmod:root"
    docker_bash "homelab-php7" "logs-chmod:root"
    docker_bash "homelab-database" "logs-chmod:root"
    cache_cmd "FLUSHALL"
    docker_down "$@"
    footer
  ;;
  backup)
    header
    backup
    footer
  ;;
  status)
    header
    status
    footer
  ;;
  makealias)
    header
    makealias
    footer
  ;;
  *)
    header
    ln
    openCD $0 
    if [ -f "logs/startup.pid" ]; then
      CUSTOM_RIGHT $LIGHT_RED 'Invalid command' $LIGHT_RED "'$subcommand'" $WHITE "⮡" "." "✘" 0
      ln
    fi
    help "$@"
    footer
  ;;
esac

